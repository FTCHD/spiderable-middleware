server {
###################
# Yours own server configuration
# As well as Phusion Passenger or MeteorUp configs
###################
  listen 80;
  listen [::]:80;
  server_name example.com ddp.example.com;
  root /path/to/public;

  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options DENY;

###################
# CRAWLABLE (pre-render) related configuration below
###################
  proxy_hide_header WWW-Authenticate;

  location / {
    try_files $uri @crawlable;
  }

  location @crawlable {
    # Do not forget to change _YOUR_AUTH_TOKEN_ to token you get from ostr.io
    proxy_set_header Authorization "Basic _YOUR_AUTH_TOKEN_";

    proxy_read_timeout    200s;
    proxy_connect_timeout 200s;
    proxy_send_timeout    200s;

    set $crawlable 0;
    set $frargment '';
    set $orig_uri  $request_uri;

    # Avoid dead loop and drop get query
    if ($orig_uri ~ "^(.*)\?(.*)$") {
      set $orig_uri $1;
    }

    # Add/remove bots from this list if needed
    if ($http_user_agent ~* "googlebot|yahoo|bingbot|facebookexternalhit|twitterbot|rogerbot|linkedinbot|embedly|quora link preview|showyoubot|outbrain|pinterest|developers.google.com/+/web/snippet|slackbot|vkShare|W3C_Validator|redditbot|Applebot|WhatsApp|flipboard|yandex|google-structured-data-testing-tool|MJ12Bot|tweetmemeBot|baiduSpider|Mail\.RU_Bot|ahrefsBot|SiteLockSpider|visionutils|tumblr|bitlybot|SkypeUriPreview|nuzzel|Discordbot|OdklBot") {
      set $crawlable 1;
    }

    if ($args ~ _escaped_fragment_) {
      set $crawlable 1;
    }

    if ($args ~ "_escaped_fragment_=(.+)") {
      set $fragment /$1;
    }

    if ($uri ~ \.(3ds|3g2|3gp|3gpp|7z|a|aac|aaf|adp|ai|aif|aiff|alz|ape|apk|appcache|ar|arj|asf|asx|atom|au|avchd|avi|bak|bbaw|bh|bin|bk|bmp|btif|bz2|bzip2|cab|caf|cco|cgm|class|cmx|cpio|cr2|crt|crx|css|csv|cur|dat|deb|der|dex|djvu|dll|dmg|dng|doc|docm|docx|dot|dotm|dra|drc|DS_Store|dsk|dts|dtshd|dvb|dwg|dxf|ear|ecelp4800|ecelp7470|ecelp9600|egg|eol|eot|eps|epub|exe|f4a|f4b|f4p|f4v|fbs|fh|fla|flac|fli|flv|fpx|fst|fvt|g3|geojson|gif|graffle|gz|gzip|h261|h263|h264|hqx|htc|ico|ief|img|ipa|iso|jad|jar|jardiff|jng|jnlp|jpeg|jpg|jpgv|jpm|js|json|jsonld|jxr|key|kml|kmz|ktx|less|lha|lvp|lz|lzh|lzma|lzo|m2v|m3u|m4a|m4p|m4v|map|mar|markdown|md|mdi|mdown|mdwn|mht|mid|midi|mj2|mka|mkd|mkdn|mkdown|mkv|mml|mmr|mng|mobi|mov|movie|mp2|mp3|mp4|mp4a|mpe|mpeg|mpg|mpga|mpv|msi|msm|msp|mxf|mxu|nef|npx|nsv|numbers|o|oex|oga|ogg|ogv|opus|otf|pages|pbm|pcx|pdb|pdf|pea|pem|pgm|pic|pl|pm|png|pnm|pot|potm|potx|ppa|ppam|ppm|pps|ppsm|ppsx|ppt|pptm|pptx|prc|ps|psd|pya|pyc|pyo|pyv|qt|ra|rar|ras|raw|rdf|rgb|rip|rlc|rm|rmf|rmvb|ron|roq|rpm|rss|rtf|run|rz|s3m|s7z|safariextz|scpt|sea|sgi|shar|sil|sit|slk|smv|so|sub|svg|svgz|svi|swf|tar|tbz|tbz2|tcl|tga|tgz|thmx|tif|tiff|tk|tlz|topojson|torrent|ttc|ttf|txt|txz|udf|uvh|uvi|uvm|uvp|uvs|uvu|vcard|vcf|viv|vob|vtt|war|wav|wax|wbmp|wdp|weba|webapp|webm|webmanifest|webp|whl|wim|wm|wma|wml|wmlc|wmv|wmx|woff|woff2|wvx|xbm|xif|xla|xlam|xloc|xls|xlsb|xlsm|xlsx|xlt|xltm|xltx|xm|xmind|xml|xpi|xpm|xsl|xwd|xz|yuv|z|zip|zipx)$) {
      set $crawlable 0;
    }

    if ($fragment ~ \.(3ds|3g2|3gp|3gpp|7z|a|aac|aaf|adp|ai|aif|aiff|alz|ape|apk|appcache|ar|arj|asf|asx|atom|au|avchd|avi|bak|bbaw|bh|bin|bk|bmp|btif|bz2|bzip2|cab|caf|cco|cgm|class|cmx|cpio|cr2|crt|crx|css|csv|cur|dat|deb|der|dex|djvu|dll|dmg|dng|doc|docm|docx|dot|dotm|dra|drc|DS_Store|dsk|dts|dtshd|dvb|dwg|dxf|ear|ecelp4800|ecelp7470|ecelp9600|egg|eol|eot|eps|epub|exe|f4a|f4b|f4p|f4v|fbs|fh|fla|flac|fli|flv|fpx|fst|fvt|g3|geojson|gif|graffle|gz|gzip|h261|h263|h264|hqx|htc|ico|ief|img|ipa|iso|jad|jar|jardiff|jng|jnlp|jpeg|jpg|jpgv|jpm|js|json|jsonld|jxr|key|kml|kmz|ktx|less|lha|lvp|lz|lzh|lzma|lzo|m2v|m3u|m4a|m4p|m4v|map|mar|markdown|md|mdi|mdown|mdwn|mht|mid|midi|mj2|mka|mkd|mkdn|mkdown|mkv|mml|mmr|mng|mobi|mov|movie|mp2|mp3|mp4|mp4a|mpe|mpeg|mpg|mpga|mpv|msi|msm|msp|mxf|mxu|nef|npx|nsv|numbers|o|oex|oga|ogg|ogv|opus|otf|pages|pbm|pcx|pdb|pdf|pea|pem|pgm|pic|pl|pm|png|pnm|pot|potm|potx|ppa|ppam|ppm|pps|ppsm|ppsx|ppt|pptm|pptx|prc|ps|psd|pya|pyc|pyo|pyv|qt|ra|rar|ras|raw|rdf|rgb|rip|rlc|rm|rmf|rmvb|ron|roq|rpm|rss|rtf|run|rz|s3m|s7z|safariextz|scpt|sea|sgi|shar|sil|sit|slk|smv|so|sub|svg|svgz|svi|swf|tar|tbz|tbz2|tcl|tga|tgz|thmx|tif|tiff|tk|tlz|topojson|torrent|ttc|ttf|txt|txz|udf|uvh|uvi|uvm|uvp|uvs|uvu|vcard|vcf|viv|vob|vtt|war|wav|wax|wbmp|wdp|weba|webapp|webm|webmanifest|webp|whl|wim|wm|wma|wml|wmlc|wmv|wmx|woff|woff2|wvx|xbm|xif|xla|xlam|xloc|xls|xlsb|xlsm|xlsx|xlt|xltm|xltx|xm|xmind|xml|xpi|xpm|xsl|xwd|xz|yuv|z|zip|zipx)$) {
      set $crawlable 0;
    }

    if ($http_upgrade) {
      set $crawlable 0;
    }

# UNCOMMENT IF NEEDED
#    For Meteor, if DDP runs on different domain / subdomain
#    And configured in same {server} block
#    if ($server_name = ddp.example.com) {
#      set $crawlable 0;
#    }

# UNCOMMENT IF NEEDED
#    Required for Meteor, or any other solution based on top of sockjs / socket.js / socket.io
#    Change "/sockjs/" path if needed
#    Without this rule requests won't be rendered
#    if ($request_uri ~* /sockjs/) {
#      access_log off;
#      set $crawlable 0;
#    }

    resolver 8.8.4.4 8.8.8.8 valid=300s; # You can change this to local DNS server

    if ($crawlable = 1) {
      access_log off;
# UNCOMMENT IF NEEDED
#      Use to avoid duplicated headers set in this config above
#      and returned from render request
#      add_header X-Prerender-Status HIT;
      set $crawlable "render.ostr.io";
      proxy_pass https://$crawlable/?url=$scheme://$host$orig_uri$fragment;
    }
  }
}